#!/usr/bin/env bash
#
# amp-ralph - Run Amp in a ralph loop until completion (interactive mode)
#
# Works with free-tier Amp accounts by using interactive mode instead of -x
#
# Usage: amp-ralph "task description" [options]
#   --max-iterations N    Maximum iterations (default: 50)
#   --completion-token T  Custom completion token (default: COMPLETE)
#   --mode MODE           Amp mode: smart, rush, deep (default: smart)
#   --continue THREAD     Continue existing thread
#
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

MAX_ITERATIONS=50
COMPLETION_TOKEN="COMPLETE"
AMP_MODE="smart"
THREAD_ID=""
TASK=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --max-iterations)
            MAX_ITERATIONS="$2"
            shift 2
            ;;
        --completion-token)
            COMPLETION_TOKEN="$2"
            shift 2
            ;;
        --mode)
            AMP_MODE="$2"
            shift 2
            ;;
        --continue)
            THREAD_ID="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: amp-ralph \"task description\" [options]"
            echo ""
            echo "Runs Amp in a ralph loop until the task is complete."
            echo "Works with free-tier accounts (uses interactive mode)."
            echo ""
            echo "Options:"
            echo "  --max-iterations N    Maximum iterations (default: 50)"
            echo "  --completion-token T  Custom completion token (default: COMPLETE)"
            echo "  --mode MODE           Amp mode: smart, rush, deep (default: smart)"
            echo "  --continue THREAD     Continue existing thread ID"
            echo ""
            echo "How it works:"
            echo "  1. Amp opens interactively with your task"
            echo "  2. Work on the task - when done, output: <promise>COMPLETE</promise>"
            echo "  3. When you exit Amp (Ctrl+C or Escape), it checks for completion"
            echo "  4. If not complete, it automatically continues the thread"
            echo ""
            echo "Example:"
            echo "  amp-ralph \"Add dark mode to settings page\""
            echo "  amp-ralph \"Fix all TypeScript errors\" --max-iterations 20"
            exit 0
            ;;
        *)
            if [[ -z "$TASK" ]]; then
                TASK="$1"
            else
                echo -e "${RED}Error: Unknown argument: $1${NC}"
                exit 1
            fi
            shift
            ;;
    esac
done

if [[ -z "$TASK" && -z "$THREAD_ID" ]]; then
    echo -e "${RED}Error: Task description required${NC}"
    echo "Usage: amp-ralph \"task description\" [options]"
    exit 1
fi

if ! command -v amp &> /dev/null; then
    echo -e "${RED}Error: amp CLI not found. Install with: npm install -g @sourcegraph/amp${NC}"
    exit 1
fi

RALPH_PROMPT="You are in RALPH LOOP mode - an autonomous development loop.

CRITICAL INSTRUCTIONS:
1. Work on this task continuously until FULLY complete
2. When FULLY COMPLETE, you MUST output exactly: <promise>${COMPLETION_TOKEN}</promise>
3. If you cannot complete in this session, summarize progress and remaining work
4. The loop will automatically continue until you output the completion promise

TASK: ${TASK}"

check_thread_complete() {
    local thread_id="$1"
    local md_output
    md_output=$(amp threads markdown "$thread_id" 2>/dev/null || echo "")
    
    if echo "$md_output" | grep -q "<promise>${COMPLETION_TOKEN}</promise>"; then
        return 0
    else
        return 1
    fi
}

get_latest_thread_id() {
    amp threads list 2>/dev/null | tail -n +2 | head -1 | awk '{print $NF}'
}

echo -e "${GREEN}${BOLD}ğŸ”„ RALPH LOOP - Autonomous Development Mode${NC}"
echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${DIM}Task: ${TASK}${NC}"
echo -e "${DIM}Max iterations: ${MAX_ITERATIONS}${NC}"
echo -e "${DIM}Completion: Output <promise>${COMPLETION_TOKEN}</promise> when done${NC}"
echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

ITERATION=1
COMPLETE=false

while [[ $ITERATION -le $MAX_ITERATIONS ]]; do
    echo -e "${CYAN}${BOLD}â”â”â” Iteration ${ITERATION}/${MAX_ITERATIONS} â”â”â”${NC}"
    echo ""
    
    if [[ $ITERATION -eq 1 && -z "$THREAD_ID" ]]; then
        echo -e "${DIM}Starting new Amp session...${NC}"
        echo -e "${DIM}Remember: Output <promise>${COMPLETION_TOKEN}</promise> when complete${NC}"
        echo ""
        
        # Start amp with the task - interactive mode
        echo "$RALPH_PROMPT" | amp -m "$AMP_MODE" --no-notifications
        
        # Get the thread ID from the most recent thread
        THREAD_ID=$(get_latest_thread_id)
        echo -e "${DIM}Thread ID: ${THREAD_ID}${NC}"
    else
        echo -e "${DIM}Continuing thread ${THREAD_ID}...${NC}"
        echo ""
        
        # Continue the existing thread
        CONTINUE_PROMPT="Continue working on the task. This is iteration ${ITERATION} of the ralph loop.

REMINDER: When FULLY COMPLETE, output: <promise>${COMPLETION_TOKEN}</promise>

If not complete yet, make progress and summarize what remains."
        
        echo "$CONTINUE_PROMPT" | amp threads continue "$THREAD_ID" -m "$AMP_MODE" --no-notifications
    fi
    
    echo ""
    echo -e "${DIM}Checking for completion...${NC}"
    
    if [[ -n "$THREAD_ID" ]] && check_thread_complete "$THREAD_ID"; then
        COMPLETE=true
        break
    fi
    
    echo ""
    echo -e "${YELLOW}Task not complete. Continue to iteration $((ITERATION + 1))?${NC}"
    echo -e "${DIM}Press Enter to continue, or Ctrl+C to stop${NC}"
    read -r
    
    ITERATION=$((ITERATION + 1))
done

echo ""
echo -e "${DIM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if $COMPLETE; then
    echo -e "${GREEN}${BOLD}âœ“ Task completed in ${ITERATION} iteration(s)${NC}"
    echo -e "${DIM}Thread: ${THREAD_ID}${NC}"
    exit 0
else
    echo -e "${YELLOW}${BOLD}âš  Reached ${MAX_ITERATIONS} iterations without completion${NC}"
    echo -e "${DIM}Thread: ${THREAD_ID}${NC}"
    echo -e "${DIM}Continue manually: amp threads continue ${THREAD_ID}${NC}"
    exit 1
fi
